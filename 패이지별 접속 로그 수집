ì¢‹ì•„ìš”, **afterEach ì¶”ê°€ + ë°±ì—”ë“œ ìˆ˜ì§‘(ë””ë¹„ ì—†ì´ ë¡œê·¸ë§Œ ë‚¨ê¹€)**ìœ¼ë¡œ ë°”ë¡œ ë¶™ì—¬ ì“¸ ìˆ˜ ìˆê²Œ ìµœì†Œêµ¬ì„± ì˜ˆì‹œë¥¼ ë“œë¦´ê²Œìš”.
(ëª¨ë“  ì½”ë“œì— import í¬í•¨í–ˆìŠµë‹ˆë‹¤.)
1) í”„ë¡ íŠ¸(Vue2) â€” router.afterEachì—ì„œ ì „ì†¡
router.js
ì½”ë“œ ë³µì‚¬
Js
// imports
import Vue from 'vue';
import VueRouter from 'vue-router';
import routes from './routes'; // ë¼ìš°íŠ¸ ì •ì˜ë¶€

Vue.use(VueRouter);

const router = new VueRouter({
  mode: 'history', // í”„ë¡œì íŠ¸ ì„¤ì •ì— ë§ê²Œ
  routes,
  scrollBehavior(to, from, saved) {
    return saved || { x: 0, y: 0 };
  },
});

// ---- (ê¸°ì¡´) ì¸ì¦/ê¶Œí•œ ì²´í¬ ë“± beforeEach ìœ ì§€ ê°€ëŠ¥ ----
router.beforeEach((to, from, next) => {
  // ì˜ˆ) if (!isAuthed && to.meta.requiresAuth) return next('/login');
  next();
});

// ---- ì¶”ì  ì „ì†¡ ìœ í‹¸(ì˜ì¡´ì„± ì—†ìŒ) ----
function postBeacon(url, data) {
  try {
    const body = JSON.stringify(data);
    const blob = new Blob([body], { type: 'application/json' });

    // 1) sendBeacon ìš°ì„ 
    if (navigator.sendBeacon && navigator.sendBeacon(url, blob)) return;

    // 2) í´ë°±: keepalive fetch
    fetch(url, {
      method: 'POST',
      body,
      headers: { 'Content-Type': 'application/json' },
      keepalive: true,
      credentials: 'include', // ì„¸ì…˜ ì¿ í‚¤ ì‚¬ìš©í•œë‹¤ë©´ ìœ ì§€
    }).catch(() => {});
  } catch (_) { /* ë¡œê¹… ì‹¤íŒ¨ëŠ” ë¬´ì‹œ */ }
}

// ---- "ì„±ê³µì ìœ¼ë¡œ ë‚´ë¹„ê²Œì´ì…˜ ì™„ë£Œëœ ë’¤" 1íšŒ ì „ì†¡ ----
router.afterEach((to, from) => {
  // íŠ¹ì • í˜ì´ì§€ë§Œ ì¹´ìš´íŠ¸í•˜ë ¤ë©´: if (!to.meta?.track) return;

  const payload = {
    path: to.path,
    name: to.name || null,
    referrerPath: from && from.path ? from.path : null,
    tsClient: new Date().toISOString(),
    appVersion: process.env.VUE_APP_VERSION || null,
    userId: window.__USER_ID__ || null,     // ë‚´ë¶€ ì‹ë³„ìë§Œ (PII ìµœì†Œí™”)
    sessionId: window.__SESSION_ID__ || null,
    locale: navigator.language || null,
  };

  postBeacon('/api/track/pageview', payload);
});

export default router;
í¬ì¸íŠ¸: afterEachëŠ” ë¼ìš°íŒ…ì´ â€œì‹¤ì œ ì™„ë£Œëœ ë’¤â€ë§Œ ì‹¤í–‰ë˜ë¯€ë¡œ ì¹´ìš´íŠ¸ ì •í™•ë„ê°€ ë†’ìŠµë‹ˆë‹¤.



ì§€ê¸ˆì²˜ëŸ¼ auth, commonë§Œ ìˆë‹¤ë©´ ì¶”ì  ì „ìš© íŒ¨í‚¤ì§€/ëª¨ë“ˆì„ ë”°ë¡œ íŒŒëŠ” ê²Œ ì œì¼ ê¹”ë”í•©ë‹ˆë‹¤.
commonì— ìš°ê²¨ë„£ìœ¼ë©´ â€œê³µí†µâ€ì´ ì ì  ë¹„ëŒ€í•´ì§€ê³  ê²½ê³„ê°€ íë ¤ì ¸ìš”. ì´ë²¤íŠ¸/ë¡œê·¸ëŠ” ë³„ ê²½ê³„ë¡œ ë‘ëŠ” ê²Œ ë‚˜ì¤‘ì— DB ë„ì…Â·í ì—°ë™í•  ë•Œë„ í¸í•©ë‹ˆë‹¤.
ì¶”ì²œ êµ¬ì¡° (íŒ¨í‚¤ì§€ & íŒŒì¼ ìœ„ì¹˜)
ì½”ë“œ ë³µì‚¬

com.example.app
 â”œâ”€ auth
 â”œâ”€ common
 â””â”€ tracking                 // â˜… ìƒˆë¡œ ìƒì„± (ë˜ëŠ” analytics)
     â”œâ”€ dto
     â”‚   â””â”€ PageViewDto.java
     â”œâ”€ web
     â”‚   â””â”€ TrackingController.java
     â”œâ”€ service
     â”‚   â””â”€ TrackingService.java         // ì§€ê¸ˆì€ ë¡œê·¸ë§Œ ë‚¨ê¸°ì§€ë§Œ í™•ì¥ ëŒ€ë¹„
     â”œâ”€ mapper                           // MyBatis ë„ì… ì‹œ
     â”‚   â”œâ”€ PageViewMapper.java
     â”‚   â””â”€ PageViewMapper.xml           // resources/mappers/PageViewMapper.xml
     â””â”€ config
         â””â”€ TrackingSecurityConfig.java  // (ì„ íƒ) /api/track/** permitAll & CSRF ì˜ˆì™¸
ì—”ë“œí¬ì¸íŠ¸ ê²½ë¡œ: /api/track/pageview (tracking ì „ìš© prefix ìœ ì§€)
ë³´ì•ˆ: Spring Security ì‚¬ìš© ì‹œ /api/track/**ëŠ” permitAll + csrf().ignoringAntMatchers(...) ê¶Œì¥
ë¡œê·¸ ë¼ìš°íŒ…: logback-spring.xmlì—ì„œ logger name="TRACKING_LOG"ë¡œ ë¶„ë¦¬(ì„ íƒ)
ì½”ë“œ ìŠ¤ì¼ˆë ˆí†¤
DTO
ì½”ë“œ ë³µì‚¬
Java
package com.example.app.tracking.dto;

import lombok.Data;

@Data
public class PageViewDto {
    private String path;
    private String name;
    private String referrerPath;
    private String tsClient;
    private String appVersion;
    private String userId;
    private String sessionId;
    private String locale;

    // ì„œë²„ ë³´ê°•
    private String userAgent;
    private String clientIp;
    private String tsServer;
}
Controller (ë¡œê·¸ë§Œ ê¸°ë¡)
ì½”ë“œ ë³µì‚¬
Java
package com.example.app.tracking.web;

import com.example.app.tracking.dto.PageViewDto;
import com.example.app.tracking.service.TrackingService;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.*;

import javax.servlet.http.HttpServletRequest;
import java.time.OffsetDateTime;

@RestController
@RequestMapping("/api/track")
public class TrackingController {

    private final TrackingService trackingService;

    public TrackingController(TrackingService trackingService) {
        this.trackingService = trackingService;
    }

    @PostMapping("/pageview")
    @ResponseStatus(HttpStatus.ACCEPTED)
    public void pageview(@RequestBody PageViewDto dto, HttpServletRequest req) {
        dto.setUserAgent(req.getHeader("User-Agent"));
        dto.setClientIp(resolveClientIp(req));
        dto.setTsServer(OffsetDateTime.now().toString());
        trackingService.logPageView(dto); // ì§€ê¸ˆì€ íŒŒì¼/ì½˜ì†” ë¡œê·¸
    }

    private String resolveClientIp(HttpServletRequest req) {
        String xff = req.getHeader("X-Forwarded-For");
        if (xff != null && !xff.isEmpty()) return xff.split(",")[0].trim();
        return req.getRemoteAddr();
    }
}
Service (ì§€ê¸ˆì€ ë¡œê·¸, ë‚˜ì¤‘ì—” DB/íë¡œ êµì²´)
ì½”ë“œ ë³µì‚¬
Java
package com.example.app.tracking.service;

import com.example.app.tracking.dto.PageViewDto;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Service;

@Service
public class TrackingService {
    private static final Logger log = LoggerFactory.getLogger("TRACKING_LOG");

    public void logPageView(PageViewDto d) {
        // í•œ ì¤„ JSON (ê°„ë‹¨ ì§ë ¬í™”)
        log.info(
          "{\"path\":\"{}\",\"name\":\"{}\",\"referrerPath\":\"{}\",\"tsClient\":\"{}\"," +
          "\"appVersion\":\"{}\",\"userId\":\"{}\",\"sessionId\":\"{}\",\"locale\":\"{}\"," +
          "\"userAgent\":\"{}\",\"clientIp\":\"{}\",\"tsServer\":\"{}\"}",
          safe(d.getPath()), safe(d.getName()), safe(d.getReferrerPath()), safe(d.getTsClient()),
          safe(d.getAppVersion()), safe(d.getUserId()), safe(d.getSessionId()), safe(d.getLocale()),
          safe(d.getUserAgent()), safe(d.getClientIp()), safe(d.getTsServer())
        );
    }

    private String safe(String s) {
        if (s == null) return "";
        return s.replace("\\", "\\\\").replace("\"", "\\\"").replace("\n"," ").replace("\r"," ");
    }
}
(ì„ íƒ) Security ì„¤ì •
ì½”ë“œ ë³µì‚¬
Java
package com.example.app.tracking.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;

@Configuration
@SuppressWarnings("deprecation")
public class TrackingSecurityConfig extends WebSecurityConfigurerAdapter {
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
          .csrf().ignoringAntMatchers("/api/track/**").and()
          .authorizeRequests()
            .antMatchers("/api/track/**").permitAll()
            .anyRequest().authenticated();
    }
}
(ì„ íƒ) logback ë¶„ë¦¬
src/main/resources/logback-spring.xml
ì½”ë“œ ë³µì‚¬
Xml
<configuration>
  <appender name="TRACKING_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
    <file>logs/tracking.log</file>
    <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
      <fileNamePattern>logs/tracking.%d{yyyy-MM-dd}.log.gz</fileNamePattern>
      <maxHistory>14</maxHistory>
    </rollingPolicy>
    <encoder><pattern>%msg%n</pattern></encoder>
  </appender>

  <logger name="TRACKING_LOG" level="INFO" additivity="false">
    <appender-ref ref="TRACKING_FILE"/>
  </logger>
</configuration>
ì™œ ë³„ë„ tracking íŒ¨í‚¤ì§€ê°€ ì¢‹ì€ê°€?
ê²½ê³„ ëª…í™•: auth(ì¸ì¦), common(ìœ í‹¸)ì™€ ë…ë¦½ â†’ ì˜ì¡´ ì—­ì „/ìŠ¤íŒŒê²Œí‹° ë°©ì§€
í™•ì¥ ìš©ì´: ë‚˜ì¤‘ì— MyBatis ë§¤í¼Â·ë°°ì¹˜Â·í(Kafka/Rabbit) ë¶™ì¼ ë•Œë„ ê°™ì€ ê²½ë¡œì— ìì—°ìŠ¤ëŸ½ê²Œ í™•ì¥
ìš´ì˜ í¸ì˜: ë¡œê·¸/ì„¤ì •/ë³´ì•ˆ ì •ì±…ì„ ëª¨ë“ˆ ë‹¨ìœ„ë¡œ ë¶„ë¦¬ ê°€ëŠ¥
ì›í•˜ë©´ tracking ëŒ€ì‹  analyticsë‚˜ metrics ë„¤ì´ë°ë„ ì¢‹ì•„ìš”.
ì»¨ë²¤ì…˜ë§Œ ì •í•´ì£¼ì‹œë©´ ê±°ê¸°ì— ë§ì¶° íŒŒì¼ ê²½ë¡œ/íŒ¨í‚¤ì§€ëª… ë°”ê¿” ë“œë¦´ê²Œìš”. ğŸ˜Š