ì¢‹ì•„ìš”, **afterEach ì¶”ê°€ + ë°±ì—”ë“œ ìˆ˜ì§‘(ë””ë¹„ ì—†ì´ ë¡œê·¸ë§Œ ë‚¨ê¹€)**ìœ¼ë¡œ ë°”ë¡œ ë¶™ì—¬ ì“¸ ìˆ˜ ìˆê²Œ ìµœì†Œêµ¬ì„± ì˜ˆì‹œë¥¼ ë“œë¦´ê²Œìš”.
(ëª¨ë“  ì½”ë“œì— import í¬í•¨í–ˆìŠµë‹ˆë‹¤.)
1) í”„ë¡ íŠ¸(Vue2) â€” router.afterEachì—ì„œ ì „ì†¡
router.js
ì½”ë“œ ë³µì‚¬
Js
// imports
import Vue from 'vue';
import VueRouter from 'vue-router';
import routes from './routes'; // ë¼ìš°íŠ¸ ì •ì˜ë¶€

Vue.use(VueRouter);

const router = new VueRouter({
  mode: 'history', // í”„ë¡œì íŠ¸ ì„¤ì •ì— ë§ê²Œ
  routes,
  scrollBehavior(to, from, saved) {
    return saved || { x: 0, y: 0 };
  },
});

// ---- (ê¸°ì¡´) ì¸ì¦/ê¶Œí•œ ì²´í¬ ë“± beforeEach ìœ ì§€ ê°€ëŠ¥ ----
router.beforeEach((to, from, next) => {
  // ì˜ˆ) if (!isAuthed && to.meta.requiresAuth) return next('/login');
  next();
});

// ---- ì¶”ì  ì „ì†¡ ìœ í‹¸(ì˜ì¡´ì„± ì—†ìŒ) ----
function postBeacon(url, data) {
  try {
    const body = JSON.stringify(data);
    const blob = new Blob([body], { type: 'application/json' });

    // 1) sendBeacon ìš°ì„ 
    if (navigator.sendBeacon && navigator.sendBeacon(url, blob)) return;

    // 2) í´ë°±: keepalive fetch
    fetch(url, {
      method: 'POST',
      body,
      headers: { 'Content-Type': 'application/json' },
      keepalive: true,
      credentials: 'include', // ì„¸ì…˜ ì¿ í‚¤ ì‚¬ìš©í•œë‹¤ë©´ ìœ ì§€
    }).catch(() => {});
  } catch (_) { /* ë¡œê¹… ì‹¤íŒ¨ëŠ” ë¬´ì‹œ */ }
}

// ---- "ì„±ê³µì ìœ¼ë¡œ ë‚´ë¹„ê²Œì´ì…˜ ì™„ë£Œëœ ë’¤" 1íšŒ ì „ì†¡ ----
router.afterEach((to, from) => {
  // íŠ¹ì • í˜ì´ì§€ë§Œ ì¹´ìš´íŠ¸í•˜ë ¤ë©´: if (!to.meta?.track) return;

  const payload = {
    path: to.path,
    name: to.name || null,
    referrerPath: from && from.path ? from.path : null,
    tsClient: new Date().toISOString(),
    appVersion: process.env.VUE_APP_VERSION || null,
    userId: window.__USER_ID__ || null,     // ë‚´ë¶€ ì‹ë³„ìë§Œ (PII ìµœì†Œí™”)
    sessionId: window.__SESSION_ID__ || null,
    locale: navigator.language || null,
  };

  postBeacon('/api/track/pageview', payload);
});

export default router;
í¬ì¸íŠ¸: afterEachëŠ” ë¼ìš°íŒ…ì´ â€œì‹¤ì œ ì™„ë£Œëœ ë’¤â€ë§Œ ì‹¤í–‰ë˜ë¯€ë¡œ ì¹´ìš´íŠ¸ ì •í™•ë„ê°€ ë†’ìŠµë‹ˆë‹¤.
2) ë°±ì—”ë“œ(Spring) â€” DB ì—†ì´ ë¡œê·¸ë§Œ ë‚¨ê¸°ê¸°
ì•„ë˜ëŠ” Spring MVC(ë¶€íŠ¸) ê¸°ì¤€. ìˆ˜ì§‘ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ë°›ì•„ì„œ SLF4J(Logback) ë¡œê·¸ë¡œ ë‚¨ê¹ë‹ˆë‹¤.
ìš´ì˜ì—ì„œ íŒŒì¼ë¡œ êµ´ë ¤ë³´ë ¤ë©´ logback ì„¤ì •ì„ ì¶”ê°€í•´ tracking.logë¡œ ë¶„ë¦¬í•˜ëŠ” ê²ƒë„ í•¨ê»˜ ì˜ˆì‹œë¥¼ ë“œë¦½ë‹ˆë‹¤.
2-1) DTO
PageViewDto.java
ì½”ë“œ ë³µì‚¬
Java
// imports
package com.example.tracking.dto;

import lombok.Data;

@Data
public class PageViewDto {
    // --- í”„ë¡ íŠ¸ì—ì„œ ìˆ˜ì§‘ ---
    private String path;
    private String name;
    private String referrerPath;
    private String tsClient;    // ISO8601
    private String appVersion;
    private String userId;      // ë‚´ë¶€ì‹ë³„ì(PII ì§€ì–‘)
    private String sessionId;
    private String locale;

    // --- ì„œë²„ì—ì„œ ë³´ê°• ---
    private String userAgent;
    private String clientIp;
    private String tsServer;    // ISO8601
}
2-2) Controller (ë¡œê·¸ ì ì¬)
TrackingController.java
ì½”ë“œ ë³µì‚¬
Java
// imports
package com.example.tracking.web;

import com.example.tracking.dto.PageViewDto;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.*;

import javax.servlet.http.HttpServletRequest;
import java.time.OffsetDateTime;

@RestController
@RequestMapping("/api/track")
public class TrackingController {

    private static final Logger log = LoggerFactory.getLogger("TRACKING_LOG"); 
    // ë³„ë„ ë¡œê±°ëª…ìœ¼ë¡œ ë¶„ë¦¬ â†’ logbackì—ì„œ ë³„ë„ íŒŒì¼ë¡œ ë¼ìš°íŒ… ê°€ëŠ¥

    @PostMapping("/pageview")
    @ResponseStatus(HttpStatus.ACCEPTED)
    public void pageview(@RequestBody PageViewDto dto, HttpServletRequest req) {
        // ì„œë²„ ë³´ê°• í•„ë“œ
        dto.setUserAgent(req.getHeader("User-Agent"));
        dto.setClientIp(resolveClientIp(req));
        dto.setTsServer(OffsetDateTime.now().toString());

        // JSON í•œ ì¤„ ë¡œê·¸ (ë¶„ì„/íŒŒì‹± ìš©ì´)
        // ìš´ì˜ì—ì„  ì¿¼ë¦¬ìŠ¤íŠ¸ë§/ê°œì¸ì •ë³´ê°€ í¬í•¨ë˜ì§€ ì•Šë„ë¡ ë°˜ë“œì‹œ í”„ë¡ íŠ¸/ì„œë²„ì—ì„œ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ì •ì±… ê¶Œì¥
        log.info("pageview {}", toLine(dto));
    }

    private String resolveClientIp(HttpServletRequest req) {
        String xff = req.getHeader("X-Forwarded-For");
        if (xff != null && !xff.isEmpty()) {
            // ì²«ë²ˆì§¸ê°€ ì‹¤ì œ í´ë¼ì´ì–¸íŠ¸ IP
            return xff.split(",")[0].trim();
        }
        return req.getRemoteAddr();
    }

    private String toLine(PageViewDto d) {
        // ê°„ë‹¨í•œ JSON ë¼ì¸ (ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—†ì´ ê°€ë³ê²Œ)
        // í•„ìš” ì‹œ Jackson ObjectMapperë¡œ ì§ë ¬í™”í•´ë„ ë©ë‹ˆë‹¤.
        return String.format(
            "{\"path\":\"%s\",\"name\":\"%s\",\"referrerPath\":\"%s\",\"tsClient\":\"%s\"," +
            "\"appVersion\":\"%s\",\"userId\":\"%s\",\"sessionId\":\"%s\",\"locale\":\"%s\"," +
            "\"userAgent\":\"%s\",\"clientIp\":\"%s\",\"tsServer\":\"%s\"}",
            safe(d.getPath()), safe(d.getName()), safe(d.getReferrerPath()), safe(d.getTsClient()),
            safe(d.getAppVersion()), safe(d.getUserId()), safe(d.getSessionId()), safe(d.getLocale()),
            safe(d.getUserAgent()), safe(d.getClientIp()), safe(d.getTsServer())
        );
    }

    private String safe(String s) {
        if (s == null) return "";
        // ì¤„ë°”ê¿ˆ/ë”°ì˜´í‘œ ìµœì†Œ ì´ìŠ¤ì¼€ì´í”„
        return s.replace("\\", "\\\\").replace("\"", "\\\"").replace("\n", " ").replace("\r", " ");
    }
}
ë°˜í™˜ì€ 202 Acceptedë¡œ ë¹„ë™ê¸°/ë² ìŠ¤íŠ¸ì—í¬íŠ¸ ëŠë‚Œì„ ì£¼ê³ , ì‹¤íŒ¨í•´ë„ UXì— ì˜í–¥ ì—†ê²Œ í•©ë‹ˆë‹¤.
2-3) (ì„ íƒ) Spring Security ì‚¬ìš© ì‹œ í—ˆìš© ì„¤ì •
Spring Securityë¥¼ ì“°ê³  ìˆê³  ì¸ì¦ì´ í•„ìš”í•œ ì•±ì´ë¼ë©´, ì¶”ì  ì—”ë“œí¬ì¸íŠ¸ëŠ” permitAllë¡œ ì—´ì–´ë‘ëŠ” í¸ì´ ì¼ë°˜ì ì…ë‹ˆë‹¤.
SecurityConfig.java (Spring Security 5.x ì˜ˆ)
ì½”ë“œ ë³µì‚¬
Java
// imports
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;

@Configuration
@SuppressWarnings("deprecation")
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
          .csrf().ignoringAntMatchers("/api/track/**").and() // CSRF ë³´í˜¸ê°€ í•„ìš” ì—†ë‹¤ë©´ ë¬´ì‹œ
          .authorizeRequests()
            .antMatchers("/api/track/**").permitAll()
            .anyRequest().authenticated();
    }
}
CSRFë¥¼ ì—„ê²©íˆ ì¼  ìƒíƒœë¼ë©´, sendBeacon + POST ì „ì†¡ì´ ì°¨ë‹¨ë  ìˆ˜ ìˆì–´ /api/track/**ëŠ” CSRF ì œì™¸í•˜ê±°ë‚˜ GET + ì¿¼ë¦¬ìŠ¤íŠ¸ë§ìœ¼ë¡œ ë°”ê¿”ì•¼ í•©ë‹ˆë‹¤(ê°œì¸ì •ë³´/ê¸¸ì´ ì´ìŠˆ ì£¼ì˜). ê°œì¸ì ìœ¼ë¡œëŠ” CSRF ì œì™¸ + JSON POSTë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.
2-4) (ì„ íƒ) Logbackìœ¼ë¡œ íŒŒì¼ ë¶„ë¦¬(ë¡¤ë§)
src/main/resources/logback-spring.xml (í•„ìš”ì‹œì—ë§Œ ì¶”ê°€)
ì½”ë“œ ë³µì‚¬
Xml
<configuration>
  <!-- ê¸°ë³¸ ì½˜ì†” Appender -->
  <appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
    <encoder>
      <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} %-5level [%thread] %logger - %msg%n</pattern>
    </encoder>
  </appender>

  <!-- TRACKING ì „ìš© ë¡¤ë§ íŒŒì¼ -->
  <appender name="TRACKING_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
    <file>logs/tracking.log</file>
    <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
      <fileNamePattern>logs/tracking.%d{yyyy-MM-dd}.log.gz</fileNamePattern>
      <maxHistory>14</maxHistory>
    </rollingPolicy>
    <encoder>
      <pattern>%msg%n</pattern> <!-- í•œ ì¤„ JSONë§Œ -->
    </encoder>
  </appender>

  <!-- ì• í”Œë¦¬ì¼€ì´ì…˜ ê¸°ë³¸ ë¡œê±° -->
  <root level="INFO">
    <appender-ref ref="STDOUT"/>
  </root>

  <!-- TRACKING ì „ìš© ë¡œê±°: TrackingControllerì—ì„œ ì‚¬ìš©í•œ ì´ë¦„ -->
  <logger name="TRACKING_LOG" level="INFO" additivity="false">
    <appender-ref ref="TRACKING_FILE"/>
    <appender-ref ref="STDOUT"/>
  </logger>
</configuration>
ê²°ê³¼: logs/tracking.logì— í•œ ì¤„ JSONë¡œ ì¶•ì ë˜ì–´, ë‚˜ì¤‘ì— DBê°€ ì •í•´ì§€ë©´ ì‰½ê²Œ ì ì¬/íŒŒì‹±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
3) ë¹ ë¥¸ ì ê²€(ì²´í¬ë¦¬ìŠ¤íŠ¸)
[ ] í”„ë¡ íŠ¸ router.afterEachì—ì„œ /api/track/pageviewë¡œ ì „ì†¡ë˜ëŠ”ì§€
[ ] ì„œë²„ì—ì„œ 202 ì‘ë‹µ, ì½˜ì†”/íŒŒì¼ì— pageview {...} ë¼ì¸ì´ ì°íˆëŠ”ì§€
[ ] ë³´ì•ˆ: /api/track/** CSRF/ì¸ì¦ ì •ì±… í™•ì¸
[ ] ê°œì¸ì •ë³´ ê³¼ìˆ˜ì§‘ ê¸ˆì§€(ì‚¬ìš©ì ì‹ë³„ìëŠ” ë‚´ë¶€ IDë§Œ, ì¿¼ë¦¬ìŠ¤íŠ¸ë§/íŒŒë¼ë¯¸í„°ëŠ” í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸)
[ ] íŠ¸ë˜í”½ ì»¤ì§€ë©´ ë‚˜ì¤‘ì— í(@Async/ë©”ì‹œì§€í) ë„ì… + DB ìŠ¤í‚¤ë§ˆ ì„¤ê³„
ì›í•˜ë©´ ì—¬ê¸°ì„œ ì²´ë¥˜ì‹œê°„(enter/leave) ê³„ì‚°, ì„¸ì…˜ë‹¹ 1íšŒ ì œí•œ, íŠ¹ì • ë¼ìš°íŠ¸ë§Œ ì¹´ìš´íŠ¸(meta.track), ë¡œë´‡ í•„í„°ë§ ê·œì¹™ê¹Œì§€ ë°”ë¡œ ì–¹ì–´ ë“œë¦´ê²Œìš”.
â€œë¼ìš°íŒ…ì€ ì •í™•í•˜ê²Œ, ê°œì¸ì •ë³´ëŠ” ìµœì†Œë¡œâ€ â€” ì´ ì›ì¹™ë§Œ ì§€í‚¤ë©´ ê¹”ë”í•˜ê²Œ êµ´ëŸ¬ê°‘ë‹ˆë‹¤. ğŸ˜Š