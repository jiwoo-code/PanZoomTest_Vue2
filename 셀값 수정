

ì½”ì–´ ë¡œì§ì„ ì „ë¶€ í•¨ìˆ˜í™”í•´ì„œ ì¬í™œìš©Â·ê°€ë…ì„±ì„ ë†’ì˜€ìŠµë‹ˆë‹¤.

<template>
  <div class="popup">
    <!-- ğŸ‘‰ ì „ì²´ ì €ì¥ ë²„íŠ¼ -->
    <sp-button
      small
      :disabled="!hasDirty"
      @click="saveAll"
      class="save-all-btn"
    >
      ì €ì¥
    </sp-button>

    <!-- ğŸ‘‰ ag-Grid -->
    <ag-grid-vue
      class="ag-theme-balham"
      style="height:420px"
      :rowData="rowData"
      :columnDefs="columnDefs"
      :gridOptions="gridOptions"
      @grid-ready="onGridReady"
    />
  </div>
</template>

<script>
import axios from '@/plugins/axios';      // í”„ë¡œì íŠ¸ axios ì¸ìŠ¤í„´ìŠ¤

export default {
  /* ìƒìœ„ì—ì„œ ê¶Œí•œ í”Œë˜ê·¸ë§Œ ë‚´ë ¤ì¤ë‹ˆë‹¤. */
  props: { canEditRemark: Boolean },

  data() {
    return {
      gridApi  : null,
      hasDirty : false,                 // ì €ì¥ ë²„íŠ¼ on/off
      rowData  : [],                    // (ìƒìœ„ì—ì„œ fetch í›„ propsë¡œ ë°›ì•„ë„ ë¬´ë°©)

      /* âœ… ì»¬ëŸ¼ ì •ì˜ */
      columnDefs: [
        { field:'id', headerName:'ID', width:80 },

        { field:'remark',
          headerName:'ë¹„ê³ ',
          editable : () => this.canEditRemark,          // ê¶Œí•œ ì²´í¬
          cellEditor: 'agLargeTextCellEditor',
          cellEditorParams:{ cols:28, rows:3 },

          /* ë³€ê²½ëœ ì…€ ë°°ê²½ í‘œì‹œ */
          cellClassRules: {
            'cell-dirty': params => !!params.data.dirty
          }
        }
      ],

      /* âœ… grid ì˜µì…˜ â€“ onCellValueChanged ì—ì„œ ë”í‹° í‘œì‹œ */
      gridOptions: {
        defaultColDef: { resizable:true, sortable:true },
        onCellValueChanged: p => this.handleEdit(p)
      }
    };
  },

  /* methods ---------------------------------------------------- */
  methods: {
    onGridReady(p) { this.gridApi = p.api; },

    /* â‘  ì…€ í¸ì§‘ â†’ dirty í”Œë˜ê·¸ ë¶€ì—¬ + ì €ì¥ë²„íŠ¼ í™œì„± */
    handleEdit(p) {
      if (p.colDef.field === 'remark' && this.canEditRemark) {
        p.data.dirty = true;                     // í–‰ í”Œë˜ê·¸
        this.hasDirty = true;
        // í•´ë‹¹ ì…€ë§Œ ë‹¤ì‹œ ë Œë” (ìƒ‰ìƒ ë°˜ì˜)
        p.api.refreshCells({ rowNodes:[p.node], columns:['remark'] });
      }
    },

    /* â‘¡ ë”í‹° í–‰ ëª¨ìœ¼ê¸° */
    collectDirtyRows() {
      const list = [];
      this.gridApi.forEachNode(n => {
        if (n.data.dirty) list.push({ id:n.data.id, remark:n.data.remark });
      });
      return list;
    },

    /* â‘¢ ì €ì¥ ë²„íŠ¼ */
    async saveAll() {
      const payload = this.collectDirtyRows();
      if (!payload.length) return;

      try {
        await axios.post('/api/history/remark/updateBatch', payload);
        this.markClean();                 // ì„±ê³µ í›„ ì´ˆê¸°í™”
        this.$toast.success('ì €ì¥ ì™„ë£Œ');
      } catch (e) {
        console.error(e);
        this.$toast.error('ì €ì¥ ì‹¤íŒ¨');
      }
    },

    /* â‘£ ì„±ê³µ ì‹œ ë”í‹° í”Œë˜ê·¸Â·í•˜ì´ë¼ì´íŠ¸ ì œê±° */
    markClean() {
      this.gridApi.forEachNode(n => {
        if (n.data.dirty) {
          n.data.dirty = false;
        }
      });
      this.hasDirty = false;
      this.gridApi.refreshCells({ force: true }); // ëª¨ë“  ì…€ ì¬ëœë” â†’ ìƒ‰ìƒ ì‚­ì œ
    }
  }
};
</script>

<style scoped>
.history-popup {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.save-all-btn {
  align-self: flex-end;
}

.cell-dirty {
  background-color: #fff5cc !important;   /* ì—°ë…¸ë‘ í•˜ì´ë¼ì´íŠ¸ */
}
</style>

ë™ì‘ ìš”ì•½

1. ë¹„ê³ (remark) ì»¬ëŸ¼ì€ canEditRemark ê°€ true ì¼ ë•Œë§Œ ìˆ˜ì • ê°€ëŠ¥.


2. ì‚¬ìš©ìê°€ í¸ì§‘í•˜ë©´ handleEdit() ì´ í–‰ì— dirty=true ë¥¼ ì‹¬ê³  ì €ì¥ ë²„íŠ¼ í™œì„±.


3. ì €ì¥ â†’ collectDirtyRows() ë¡œ ë”í‹° í–‰ë§Œ payload ë¡œ ì „ì†¡.


4. ì„±ê³µ ì‹œ markClean() ìœ¼ë¡œ í”Œë˜ê·¸ ì§€ìš°ê³  ì…€ í•˜ì´ë¼ì´íŠ¸ ì œê±°.



> ëª¨ë“  ë¡œì§ì„ í•¨ìˆ˜í™”(handleEdit Â· collectDirtyRows Â· markClean) í–ˆê¸° ë•Œë¬¸ì—
ì¶”í›„ ë‹¤ë¥¸ íŒì—…/í˜ì´ì§€ì—ì„œë„ ê·¸ëŒ€ë¡œ ê°€ì ¸ë‹¤ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.



