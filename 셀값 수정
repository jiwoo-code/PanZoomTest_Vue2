

ì½”ì–´ ë¡œì§ì„ ì „ë¶€ í•¨ìˆ˜í™”í•´ì„œ ì¬í™œìš©Â·ê°€ë…ì„±ì„ ë†’ì˜€ìŠµë‹ˆë‹¤.

<template>
  <div class="popup">
    <!-- ğŸ‘‰ ì „ì²´ ì €ì¥ ë²„íŠ¼ -->
    <sp-button
      small
      :disabled="!hasDirty"
      @click="saveAll"
      class="save-all-btn"
    >
      ì €ì¥
    </sp-button>

    <!-- ğŸ‘‰ ag-Grid -->
    <ag-grid-vue
      class="ag-theme-balham"
      style="height:420px"
      :rowData="rowData"
      :columnDefs="columnDefs"
      :gridOptions="gridOptions"
      @grid-ready="onGridReady"
    />
  </div>
</template>

<script>
import axios from '@/plugins/axios';      // í”„ë¡œì íŠ¸ axios ì¸ìŠ¤í„´ìŠ¤

export default {
  /* ìƒìœ„ì—ì„œ ê¶Œí•œ í”Œë˜ê·¸ë§Œ ë‚´ë ¤ì¤ë‹ˆë‹¤. */
  props: { canEditRemark: Boolean },

  data() {
    return {
      gridApi  : null,
      hasDirty : false,                 // ì €ì¥ ë²„íŠ¼ on/off
      rowData  : [],                    // (ìƒìœ„ì—ì„œ fetch í›„ propsë¡œ ë°›ì•„ë„ ë¬´ë°©)

      /* âœ… ì»¬ëŸ¼ ì •ì˜ */
      columnDefs: [
        { field:'id', headerName:'ID', width:80 },

        { field:'remark',
          headerName:'ë¹„ê³ ',
          editable : () => this.canEditRemark,          // ê¶Œí•œ ì²´í¬
          cellEditor: 'agLargeTextCellEditor',
          cellEditorParams:{ cols:28, rows:3 },

          /* ë³€ê²½ëœ ì…€ ë°°ê²½ í‘œì‹œ */
          cellClassRules: {
            'cell-dirty': params => !!params.data.dirty
          }
        }
      ],

      /* âœ… grid ì˜µì…˜ â€“ onCellValueChanged ì—ì„œ ë”í‹° í‘œì‹œ */
      gridOptions: {
        defaultColDef: { resizable:true, sortable:true },
        onCellValueChanged: p => this.handleEdit(p)
      }
    };
  },

  /* methods ---------------------------------------------------- */
  methods: {
    onGridReady(p) { this.gridApi = p.api; },

    /* â‘  ì…€ í¸ì§‘ â†’ dirty í”Œë˜ê·¸ ë¶€ì—¬ + ì €ì¥ë²„íŠ¼ í™œì„± */
    handleEdit(p) {
      if (p.colDef.field === 'remark' && this.canEditRemark) {
        p.data.dirty = true;                     // í–‰ í”Œë˜ê·¸
        this.hasDirty = true;
        // í•´ë‹¹ ì…€ë§Œ ë‹¤ì‹œ ë Œë” (ìƒ‰ìƒ ë°˜ì˜)
        p.api.refreshCells({ rowNodes:[p.node], columns:['remark'] });
      }
    },

    /* â‘¡ ë”í‹° í–‰ ëª¨ìœ¼ê¸° */
    collectDirtyRows() {
      const list = [];
      this.gridApi.forEachNode(n => {
        if (n.data.dirty) list.push({ id:n.data.id, remark:n.data.remark });
      });
      return list;
    },

    /* â‘¢ ì €ì¥ ë²„íŠ¼ */
    async saveAll() {
      const payload = this.collectDirtyRows();
      if (!payload.length) return;

      try {
        await axios.post('/api/history/remark/updateBatch', payload);
        this.markClean();                 // ì„±ê³µ í›„ ì´ˆê¸°í™”
        this.$toast.success('ì €ì¥ ì™„ë£Œ');
      } catch (e) {
        console.error(e);
        this.$toast.error('ì €ì¥ ì‹¤íŒ¨');
      }
    },

    /* â‘£ ì„±ê³µ ì‹œ ë”í‹° í”Œë˜ê·¸Â·í•˜ì´ë¼ì´íŠ¸ ì œê±° */
    markClean() {
      this.gridApi.forEachNode(n => {
        if (n.data.dirty) {
          n.data.dirty = false;
        }
      });
      this.hasDirty = false;
      this.gridApi.refreshCells({ force: true }); // ëª¨ë“  ì…€ ì¬ëœë” â†’ ìƒ‰ìƒ ì‚­ì œ
    }
  }
};
</script>

<style scoped>
.history-popup {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.save-all-btn {
  align-self: flex-end;
}

.cell-dirty {
  background-color: #fff5cc !important;   /* ì—°ë…¸ë‘ í•˜ì´ë¼ì´íŠ¸ */
}
</style>

ë™ì‘ ìš”ì•½

1. ë¹„ê³ (remark) ì»¬ëŸ¼ì€ canEditRemark ê°€ true ì¼ ë•Œë§Œ ìˆ˜ì • ê°€ëŠ¥.


2. ì‚¬ìš©ìê°€ í¸ì§‘í•˜ë©´ handleEdit() ì´ í–‰ì— dirty=true ë¥¼ ì‹¬ê³  ì €ì¥ ë²„íŠ¼ í™œì„±.


3. ì €ì¥ â†’ collectDirtyRows() ë¡œ ë”í‹° í–‰ë§Œ payload ë¡œ ì „ì†¡.


4. ì„±ê³µ ì‹œ markClean() ìœ¼ë¡œ í”Œë˜ê·¸ ì§€ìš°ê³  ì…€ í•˜ì´ë¼ì´íŠ¸ ì œê±°.



> ëª¨ë“  ë¡œì§ì„ í•¨ìˆ˜í™”(handleEdit Â· collectDirtyRows Â· markClean) í–ˆê¸° ë•Œë¬¸ì—
ì¶”í›„ ë‹¤ë¥¸ íŒì—…/í˜ì´ì§€ì—ì„œë„ ê·¸ëŒ€ë¡œ ê°€ì ¸ë‹¤ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.



ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡




<template>
  <div class="grid-container">
    <div class="ag-theme-balham" style="height: 400px; width: 100%;">
      <ag-grid-vue
        ref="agGrid"
        :columnDefs="columnDefs"
        :rowData="rowData"
        :defaultColDef="defaultColDef"
        :suppressRowClickSelection="true"
        @grid-ready="onGridReady"
        @cell-value-changed="onCellValueChanged"
      />
    </div>
    
    <!-- í•˜ë‹¨ ë²„íŠ¼ -->
    <div class="button-container">
      <button 
        :disabled="!hasChanges" 
        @click="saveChanges"
      >
        ë³€ê²½ì‚¬í•­ ì €ì¥
      </button>
    </div>
  </div>
</template>

<script>
import { AgGridVue } from 'ag-grid-vue'

export default {
  name: 'EditableGrid',
  components: {
    AgGridVue
  },
  data() {
    return {
      gridApi: null,
      columnApi: null,
      hasChanges: false,
      originalData: [], // ì›ë³¸ ë°ì´í„° ì €ì¥
      changedRows: new Set(), // ë³€ê²½ëœ í–‰ ì¶”ì 
      rowData: [
        { id: 1, name: 'í™ê¸¸ë™', department: 'ê°œë°œíŒ€', remark: 'ìš°ìˆ˜ ì§ì›' },
        { id: 2, name: 'ê¹€ì² ìˆ˜', department: 'ë§ˆì¼€íŒ…íŒ€', remark: 'ì‹ ì… ì§ì›' },
        { id: 3, name: 'ì´ì˜í¬', department: 'ë””ìì¸íŒ€', remark: 'ì°½ì˜ì ' },
        { id: 4, name: 'ë°•ë¯¼ìˆ˜', department: 'ê¸°íšíŒ€', remark: 'ì ê·¹ì ' },
        { id: 5, name: 'ì •ìˆ˜ì§„', department: 'ì¸ì‚¬íŒ€', remark: 'ê¼¼ê¼¼í•¨' }
      ],
      columnDefs: [
        { 
          headerName: 'ID', 
          field: 'id', 
          width: 80,
          editable: false
        },
        { 
          headerName: 'ì´ë¦„', 
          field: 'name', 
          width: 120,
          editable: false
        },
        { 
          headerName: 'ë¶€ì„œ', 
          field: 'department', 
          width: 150,
          editable: false
        },
        { 
          headerName: 'ë¹„ê³ ', 
          field: 'remark', 
          width: 200,
          editable: true,
          cellEditor: 'agTextCellEditor',
          cellStyle: (params) => {
            if (this.changedRows.has(params.data.id)) {
              return { backgroundColor: '#ffeb3b', fontWeight: 'bold' }
            }
            return null
          },
          cellEditorParams: {
            maxLength: 100
          }
        }
      ],
      defaultColDef: {
        sortable: true,
        filter: true,
        resizable: true
      }
    }
  },
  mounted() {
    // ì›ë³¸ ë°ì´í„° ê¹Šì€ ë³µì‚¬ë¡œ ì €ì¥
    this.originalData = JSON.parse(JSON.stringify(this.rowData))
  },
  methods: {
    onGridReady(params) {
      this.gridApi = params.api
      this.columnApi = params.columnApi
    },
    
    onCellValueChanged(event) {
      // remark ì»¬ëŸ¼ì˜ ë³€ê²½ì‚¬í•­ë§Œ ì²´í¬
      if (event.colDef.field === 'remark') {
        this.checkForChanges(event)
      }
    },
    
    checkForChanges(event) {
      const rowId = event.data.id
      const currentValue = event.newValue
      const originalValue = this.originalData.find(item => item.id === rowId)?.remark
      
      if (currentValue !== originalValue) {
        // ë³€ê²½ëœ í–‰ ì¶”ê°€
        this.changedRows.add(rowId)
      } else {
        // ì›ë³¸ê³¼ ê°™ì•„ì§€ë©´ ë³€ê²½ëœ í–‰ì—ì„œ ì œê±°
        this.changedRows.delete(rowId)
      }
      
      // ë³€ê²½ì‚¬í•­ ìˆëŠ”ì§€ í™•ì¸
      this.hasChanges = this.changedRows.size > 0
      
      // ì…€ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ ê·¸ë¦¬ë“œ ë¦¬í”„ë ˆì‹œ
      this.gridApi.refreshCells({
        rowNodes: [event.node],
        columns: ['remark'],
        force: true
      })
    },
    
    saveChanges() {
      if (!this.hasChanges) return
      
      // í˜„ì¬ ê·¸ë¦¬ë“œ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì„œ ì €ì¥
      const currentData = []
      this.gridApi.forEachNode(node => {
        currentData.push({ ...node.data })
      })
      
      // ë³€ê²½ëœ í–‰ë“¤ë§Œ ì¶”ì¶œ
      const changedData = currentData.filter(item => this.changedRows.has(item.id))
      
      console.log('ë³€ê²½ëœ ë°ì´í„°:', changedData)
      
      // ì‹¤ì œ ì„œë²„ ì €ì¥ ë¡œì§ì€ ì—¬ê¸°ì— êµ¬í˜„
      // ì €ì¥ í›„ ë¡œë“œ í•¨ìˆ˜ í˜¸ì¶œ ì˜ˆì •
      // this.loadData() // ë¡œë“œ í•¨ìˆ˜ì—ì„œ originalData ë°±ì—… ì²˜ë¦¬
      
      // ì„ì‹œë¡œ ë³€ê²½ì‚¬í•­ ì´ˆê¸°í™” (ì‹¤ì œë¡œëŠ” ë¡œë“œ í•¨ìˆ˜ì—ì„œ ì²˜ë¦¬)
      this.resetChangesState()
      
      alert('ë³€ê²½ì‚¬í•­ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.')
    },
    
    resetChangesState() {
      this.changedRows.clear()
      this.hasChanges = false
      this.gridApi.refreshCells({
        columns: ['remark'],
        force: true
      })
    },
    
    // ë¡œë“œ í•¨ìˆ˜ì—ì„œ í˜¸ì¶œí•  ë©”ì„œë“œ
    loadData() {
      // ë°ì´í„° ë¡œë“œ ë¡œì§
      // ...
      
      // ì›ë³¸ ë°ì´í„° ë°±ì—…
      this.originalData = JSON.parse(JSON.stringify(this.rowData))
      this.resetChangesState()
    }
  }
}
</script>

<style scoped>
.grid-container {
  padding: 20px;
}

.button-container {
  margin-top: 20px;
}
</style>