

ì½”ì–´ ë¡œì§ì„ ì „ë¶€ í•¨ìˆ˜í™”í•´ì„œ ì¬í™œìš©Â·ê°€ë…ì„±ì„ ë†’ì˜€ìŠµë‹ˆë‹¤.

<template>
  <div class="popup">
    <!-- ğŸ‘‰ ì „ì²´ ì €ì¥ ë²„íŠ¼ -->
    <sp-button
      small
      :disabled="!hasDirty"
      @click="saveAll"
      class="save-all-btn"
    >
      ì €ì¥
    </sp-button>

    <!-- ğŸ‘‰ ag-Grid -->
    <ag-grid-vue
      class="ag-theme-balham"
      style="height:420px"
      :rowData="rowData"
      :columnDefs="columnDefs"
      :gridOptions="gridOptions"
      @grid-ready="onGridReady"
    />
  </div>
</template>

<script>
import axios from '@/plugins/axios';      // í”„ë¡œì íŠ¸ axios ì¸ìŠ¤í„´ìŠ¤

export default {
  /* ìƒìœ„ì—ì„œ ê¶Œí•œ í”Œë˜ê·¸ë§Œ ë‚´ë ¤ì¤ë‹ˆë‹¤. */
  props: { canEditRemark: Boolean },

  data() {
    return {
      gridApi  : null,
      hasDirty : false,                 // ì €ì¥ ë²„íŠ¼ on/off
      rowData  : [],                    // (ìƒìœ„ì—ì„œ fetch í›„ propsë¡œ ë°›ì•„ë„ ë¬´ë°©)

      /* âœ… ì»¬ëŸ¼ ì •ì˜ */
      columnDefs: [
        { field:'id', headerName:'ID', width:80 },

        { field:'remark',
          headerName:'ë¹„ê³ ',
          editable : () => this.canEditRemark,          // ê¶Œí•œ ì²´í¬
          cellEditor: 'agLargeTextCellEditor',
          cellEditorParams:{ cols:28, rows:3 },

          /* ë³€ê²½ëœ ì…€ ë°°ê²½ í‘œì‹œ */
          cellClassRules: {
            'cell-dirty': params => !!params.data.dirty
          }
        }
      ],

      /* âœ… grid ì˜µì…˜ â€“ onCellValueChanged ì—ì„œ ë”í‹° í‘œì‹œ */
      gridOptions: {
        defaultColDef: { resizable:true, sortable:true },
        onCellValueChanged: p => this.handleEdit(p)
      }
    };
  },

  /* methods ---------------------------------------------------- */
  methods: {
    onGridReady(p) { this.gridApi = p.api; },

    /* â‘  ì…€ í¸ì§‘ â†’ dirty í”Œë˜ê·¸ ë¶€ì—¬ + ì €ì¥ë²„íŠ¼ í™œì„± */
    handleEdit(p) {
      if (p.colDef.field === 'remark' && this.canEditRemark) {
        p.data.dirty = true;                     // í–‰ í”Œë˜ê·¸
        this.hasDirty = true;
        // í•´ë‹¹ ì…€ë§Œ ë‹¤ì‹œ ë Œë” (ìƒ‰ìƒ ë°˜ì˜)
        p.api.refreshCells({ rowNodes:[p.node], columns:['remark'] });
      }
    },

    /* â‘¡ ë”í‹° í–‰ ëª¨ìœ¼ê¸° */
    collectDirtyRows() {
      const list = [];
      this.gridApi.forEachNode(n => {
        if (n.data.dirty) list.push({ id:n.data.id, remark:n.data.remark });
      });
      return list;
    },

    /* â‘¢ ì €ì¥ ë²„íŠ¼ */
    async saveAll() {
      const payload = this.collectDirtyRows();
      if (!payload.length) return;

      try {
        await axios.post('/api/history/remark/updateBatch', payload);
        this.markClean();                 // ì„±ê³µ í›„ ì´ˆê¸°í™”
        this.$toast.success('ì €ì¥ ì™„ë£Œ');
      } catch (e) {
        console.error(e);
        this.$toast.error('ì €ì¥ ì‹¤íŒ¨');
      }
    },

    /* â‘£ ì„±ê³µ ì‹œ ë”í‹° í”Œë˜ê·¸Â·í•˜ì´ë¼ì´íŠ¸ ì œê±° */
    markClean() {
      this.gridApi.forEachNode(n => {
        if (n.data.dirty) {
          n.data.dirty = false;
        }
      });
      this.hasDirty = false;
      this.gridApi.refreshCells({ force: true }); // ëª¨ë“  ì…€ ì¬ëœë” â†’ ìƒ‰ìƒ ì‚­ì œ
    }
  }
};
</script>

<style scoped>
.history-popup {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.save-all-btn {
  align-self: flex-end;
}

.cell-dirty {
  background-color: #fff5cc !important;   /* ì—°ë…¸ë‘ í•˜ì´ë¼ì´íŠ¸ */
}
</style>

ë™ì‘ ìš”ì•½

1. ë¹„ê³ (remark) ì»¬ëŸ¼ì€ canEditRemark ê°€ true ì¼ ë•Œë§Œ ìˆ˜ì • ê°€ëŠ¥.


2. ì‚¬ìš©ìê°€ í¸ì§‘í•˜ë©´ handleEdit() ì´ í–‰ì— dirty=true ë¥¼ ì‹¬ê³  ì €ì¥ ë²„íŠ¼ í™œì„±.


3. ì €ì¥ â†’ collectDirtyRows() ë¡œ ë”í‹° í–‰ë§Œ payload ë¡œ ì „ì†¡.


4. ì„±ê³µ ì‹œ markClean() ìœ¼ë¡œ í”Œë˜ê·¸ ì§€ìš°ê³  ì…€ í•˜ì´ë¼ì´íŠ¸ ì œê±°.



> ëª¨ë“  ë¡œì§ì„ í•¨ìˆ˜í™”(handleEdit Â· collectDirtyRows Â· markClean) í–ˆê¸° ë•Œë¬¸ì—
ì¶”í›„ ë‹¤ë¥¸ íŒì—…/í˜ì´ì§€ì—ì„œë„ ê·¸ëŒ€ë¡œ ê°€ì ¸ë‹¤ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.



ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡


<template>
  <div class="grid-container">
    <div class="ag-theme-alpine" style="height: 400px; width: 100%;">
      <ag-grid-vue
        ref="agGrid"
        :columnDefs="columnDefs"
        :rowData="rowData"
        :defaultColDef="defaultColDef"
        :suppressRowClickSelection="true"
        @grid-ready="onGridReady"
        @cell-value-changed="onCellValueChanged"
      />
    </div>
    
    <!-- í•˜ë‹¨ ë²„íŠ¼ -->
    <div class="button-container">
      <button 
        :disabled="!hasChanges" 
        :class="{ 'active': hasChanges }"
        @click="saveChanges"
      >
        ë³€ê²½ì‚¬í•­ ì €ì¥
      </button>
      <button 
        :disabled="!hasChanges"
        @click="resetChanges"
      >
        ë³€ê²½ì‚¬í•­ ì·¨ì†Œ
      </button>
    </div>
  </div>
</template>

<script>
import { AgGridVue } from 'ag-grid-vue'

export default {
  name: 'EditableGrid',
  components: {
    AgGridVue
  },
  data() {
    return {
      gridApi: null,
      columnApi: null,
      hasChanges: false,
      originalData: [], // ì›ë³¸ ë°ì´í„° ì €ì¥
      rowData: [
        { id: 1, name: 'í™ê¸¸ë™', department: 'ê°œë°œíŒ€', remark: 'ìš°ìˆ˜ ì§ì›' },
        { id: 2, name: 'ê¹€ì² ìˆ˜', department: 'ë§ˆì¼€íŒ…íŒ€', remark: 'ì‹ ì… ì§ì›' },
        { id: 3, name: 'ì´ì˜í¬', department: 'ë””ìì¸íŒ€', remark: 'ì°½ì˜ì ' },
        { id: 4, name: 'ë°•ë¯¼ìˆ˜', department: 'ê¸°íšíŒ€', remark: 'ì ê·¹ì ' },
        { id: 5, name: 'ì •ìˆ˜ì§„', department: 'ì¸ì‚¬íŒ€', remark: 'ê¼¼ê¼¼í•¨' }
      ],
      columnDefs: [
        { 
          headerName: 'ID', 
          field: 'id', 
          width: 80,
          editable: false
        },
        { 
          headerName: 'ì´ë¦„', 
          field: 'name', 
          width: 120,
          editable: false
        },
        { 
          headerName: 'ë¶€ì„œ', 
          field: 'department', 
          width: 150,
          editable: false
        },
        { 
          headerName: 'ë¹„ê³ ', 
          field: 'remark', 
          width: 200,
          editable: true,
          cellEditor: 'agTextCellEditor',
          cellStyle: { 
            backgroundColor: '#f0f8ff',
            cursor: 'pointer'
          },
          cellEditorParams: {
            maxLength: 100
          }
        }
      ],
      defaultColDef: {
        sortable: true,
        filter: true,
        resizable: true
      }
    }
  },
  mounted() {
    // ì›ë³¸ ë°ì´í„° ê¹Šì€ ë³µì‚¬ë¡œ ì €ì¥
    this.originalData = JSON.parse(JSON.stringify(this.rowData))
  },
  methods: {
    onGridReady(params) {
      this.gridApi = params.api
      this.columnApi = params.columnApi
    },
    
    onCellValueChanged(event) {
      // remark ì»¬ëŸ¼ì˜ ë³€ê²½ì‚¬í•­ë§Œ ì²´í¬
      if (event.colDef.field === 'remark') {
        this.checkForChanges()
      }
    },
    
    checkForChanges() {
      const currentData = []
      this.gridApi.forEachNode(node => {
        currentData.push(node.data)
      })
      
      // ì›ë³¸ ë°ì´í„°ì™€ í˜„ì¬ ë°ì´í„°ì˜ remark í•„ë“œ ë¹„êµ
      let hasRemarkChanges = false
      
      for (let i = 0; i < currentData.length; i++) {
        const current = currentData[i]
        const original = this.originalData.find(item => item.id === current.id)
        
        if (original && current.remark !== original.remark) {
          hasRemarkChanges = true
          break
        }
      }
      
      this.hasChanges = hasRemarkChanges
    },
    
    saveChanges() {
      if (!this.hasChanges) return
      
      // í˜„ì¬ ê·¸ë¦¬ë“œ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì„œ ì›ë³¸ ë°ì´í„° ì—…ë°ì´íŠ¸
      const currentData = []
      this.gridApi.forEachNode(node => {
        currentData.push({ ...node.data })
      })
      
      // ì›ë³¸ ë°ì´í„° ì—…ë°ì´íŠ¸
      this.originalData = JSON.parse(JSON.stringify(currentData))
      this.hasChanges = false
      
      // ì‹¤ì œ ì„œë²„ ì €ì¥ ë¡œì§ì€ ì—¬ê¸°ì— êµ¬í˜„
      console.log('ë³€ê²½ì‚¬í•­ ì €ì¥ë¨:', currentData)
      alert('ë³€ê²½ì‚¬í•­ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.')
    },
    
    resetChanges() {
      if (!this.hasChanges) return
      
      // ì›ë³¸ ë°ì´í„°ë¡œ ë³µì›
      this.rowData = JSON.parse(JSON.stringify(this.originalData))
      this.hasChanges = false
      
      console.log('ë³€ê²½ì‚¬í•­ ì·¨ì†Œë¨')
    }
  }
}
</script>

<style scoped>
.grid-container {
  padding: 20px;
}

.button-container {
  margin-top: 20px;
  display: flex;
  gap: 10px;
}

button {
  padding: 10px 20px;
  border: 1px solid #ddd;
  border-radius: 4px;
  background-color: #f8f9fa;
  cursor: pointer;
  transition: all 0.2s;
}

button:disabled {
  background-color: #e9ecef;
  color: #6c757d;
  cursor: not-allowed;
  opacity: 0.6;
}

button:not(:disabled):hover {
  background-color: #e9ecef;
}

button.active {
  background-color: #007bff;
  color: white;
  border-color: #007bff;
}

button.active:hover {
  background-color: #0056b3;
}

/* AG Grid ìŠ¤íƒ€ì¼ ì»¤ìŠ¤í„°ë§ˆì´ì§• */
:deep(.ag-theme-alpine) {
  --ag-border-color: #ddd;
  --ag-header-background-color: #f8f9fa;
}

/* í¸ì§‘ ê°€ëŠ¥í•œ ì…€ ìŠ¤íƒ€ì¼ */
:deep(.ag-cell[col-id="remark"]) {
  position: relative;
}

:deep(.ag-cell[col-id="remark"]:hover) {
  background-color: #e3f2fd !important;
}

:deep(.ag-cell-edit-input) {
  border: 2px solid #007bff;
  border-radius: 4px;
  padding: 4px 8px;
}
</style>